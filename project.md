# –ê–Ω–∞–ª–∏–∑ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã: Remnawave Telegram Bot

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

–ù–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ñ–∞–π–ª–µ ./structure.txt

- `bot/` ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π –¥–æ–º–µ–Ω, —Ä–∞–∑–¥–µ–ª—ë–Ω–Ω—ã–π –ø–æ —Å–ª–æ—è–º: `handlers` –æ–±—Å–ª—É–∂–∏–≤–∞—é—Ç –¥–∏–∞–ª–æ–≥–∏ –±–æ—Ç–∞, `services` –∏–Ω–∫–∞–ø—Å—É–ª–∏—Ä—É—é—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É (–ø–æ–¥–ø–∏—Å–∫–∏, –æ–ø–ª–∞—Ç—ã, —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞), `middlewares` —Ä–µ–∞–ª–∏–∑—É—é—Ç cross-cutting –∑–∞–¥–∞—á–∏ (—Å–µ—Å—Å–∏–∏ –ë–î, i18n, –±–∞–Ω-–ª–∏—Å—Ç, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ), `utils` —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã (–æ—á–µ—Ä–µ–¥—å —Å–æ–æ–±—â–µ–Ω–∏–π, —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤).
- `config/settings.py` –æ–ø–∏—Å—ã–≤–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —á–µ—Ä–µ–∑ `pydantic` —Å –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—ã–º–∏ –ø–æ–ª—è–º–∏ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π, —Ñ–æ—Ä–º–∏—Ä—É—è –µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ truth –¥–ª—è env (`config/settings.py:1`).
- `db/` —Å–æ—á–µ—Ç–∞–µ—Ç –æ–ø–∏—Å–∞–Ω–∏–µ –º–æ–¥–µ–ª–µ–π SQLAlchemy, –ª—ë–≥–∫–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –∏ DAL —Å —è–≤–Ω—ã–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `db/dal/subscription_dal.py` –¥–ª—è –∞–ø–¥–µ–π—Ç–∞ –ø–æ–¥–ø–∏—Å–æ–∫).
- `locales/` –∏ `bot/middlewares/i18n.py` —Ä–µ–∞–ª–∏–∑—É—é—Ç JSON-–±–∞–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—é.
- `Dockerfile`, `docker-compose.yml` –∏ `.github/workflows/*` –∑–∞–¥–∞—é—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—é –∏ CI/CD –ø—É–±–ª–∏–∫–∞—Ü–∏—é.
- `stack.env` –∏ `structure.txt` ‚Äî –æ–∫—Ä—É–∂–µ–Ω—á–µ—Å–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã –∏ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (–æ–±–Ω–∞—Ä—É–∂–µ–Ω production-—Ç–æ–∫–µ–Ω –≤ `stack.env:1`, —á—Ç–æ —Ç—Ä–µ–±—É–µ—Ç –∏–∑—ä—è—Ç–∏—è –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è).

–ö–æ–¥ –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω –¥–æ–º–µ–Ω–Ω–æ: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ —Ä–∞–∑–Ω–µ—Å–µ–Ω—ã –ø–æ –ø–æ–¥–ø–∞–ø–∫–∞–º, —Å–µ—Ä–≤–∏—Å—ã –≥—Ä—É–ø–ø–∏—Ä—É—é—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ (YooKassa, CryptoPay, Tribute, Remnawave Panel) –∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö —á–µ—Ä–µ–∑ –∏–Ω—ä–µ–∫—Ü–∏—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π. –í—ã–¥–µ–ª–µ–Ω–Ω—ã–µ middleware/routers –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç —á–∏—Å—Ç—ã–µ —Ç–æ—á–∫–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è.

## üõ† –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫
| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è | –í–µ—Ä—Å–∏—è / –∏—Å—Ç–æ—á–Ω–∏–∫ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
| --- | --- | --- | --- |
| –Ø–∑—ã–∫ | Python | 3.11 (`Dockerfile`) | –û—Å–Ω–æ–≤–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞ |
| Telegram SDK | Aiogram | 3.21.0 (`requirements.txt`) | –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ —Ä–æ—É—Ç–µ—Ä—ã, FSM, –≤–µ–±—Ö—É–∫–∏ |
| –í–µ–±-—Å–µ—Ä–≤–µ—Ä | AIOHTTP | 3.12.14 | –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–µ–±—Ö—É–∫–æ–≤ Telegram, YooKassa, Tribute, CryptoPay |
| –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è | pydantic / pydantic-settings | 2.7.1 / latest | –¢–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ env-–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –≤—ã—á–∏—Å–ª—è–µ–º—ã–µ –ø–æ–ª—è |
| –ë–î | SQLAlchemy[asyncio] 2.0.29 + asyncpg 0.29.0 | PostgreSQL | ORM —Å–ª–æ–π, —Ä–∞–±–æ—Ç–∞ –≤ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã—Ö —Å–µ—Å—Å–∏—è—Ö |
| –ü–ª–∞—Ç–µ–∂–∏ | yookassa 3.5.0, aiocryptopay 0.4.8, Tribute API (–∫–∞—Å—Ç–æ–º) | SDK / HTTP | –ú–Ω–æ–≥–æ–∫–∞–Ω–∞–ª—å–Ω—ã–µ –æ–ø–ª–∞—Ç—ã –∏ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ | aiohttp, pycountry, python-dotenv | latest | HTTP-–∫–ª–∏–µ–Ω—Ç Remnawave Panel, –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è |
| –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ | Docker Compose, GitHub Actions | `docker-compose.yml`, `.github/workflows/*` | –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è, —Å–±–æ—Ä–∫–∞ –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—è –æ–±—Ä–∞–∑–æ–≤ |
| UI | Telegram Inline Keyboards (`bot/keyboards/inline`) | ‚Äî | –ú–µ–Ω—é, –ø–ª–∞—Ç–µ–∂–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏, WebApp-–∫–Ω–æ–ø–∫–∏ |
| –°–æ—Å—Ç–æ—è–Ω–∏—è | Aiogram FSM (`bot/states/*`) | ‚Äî | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —à–∞–≥–∞–º–∏ –¥–∏–∞–ª–æ–≥–æ–≤ –∏ –ø—Ä–æ–º–æ-—Ñ–ª–æ—É |

–í–µ—Ä—Å–∏–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, `pydantic_settings`) –Ω–µ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω—ã —è–≤–Ω–æ ‚Äî —Å—Ç–æ–∏—Ç –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –∏—Ö –≤ `requirements.txt` –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç–∏.

## üèó –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- **Bootstrap & –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è**: `main.py` –∑–∞–≥—Ä—É–∂–∞–µ—Ç env, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ë–î –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç `run_bot`, –≥–¥–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞, —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤–µ–±—Ö—É–∫–æ–≤, –∑–∞–ø—É—Å–∫ AIOHTTP —Å–µ—Ä–≤–µ—Ä–∞ –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤ (`bot/main_bot.py:90`). –ó–∞–ø—É—Å–∫ —Å—Ç—Ä–æ–≥–æ –≤ webhook-—Ä–µ–∂–∏–º–µ, polling –æ—Ç–∫–ª—é—á—ë–Ω.
- **–°–ª–æ–π –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏**: `build_root_router` –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ, inline –∏ –∞–¥–º–∏–Ω—Å–∫–∏–µ —Ä–æ—É—Ç–µ—Ä—ã, –ø—Ä–∏–º–µ–Ω—è—è —Ñ–∏–ª—å—Ç—Ä—ã —á–∞—Ç–∞ –∏ –∫–∞—Å—Ç–æ–º–Ω—ã–π `AdminFilter` (`bot/routers.py:5`). –ö–∞–∂–¥—ã–π –¥–æ–º–µ–Ω–Ω—ã–π —Ä–∞–∑–¥–µ–ª (`handlers/user`, `handlers/admin`) —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω –ø–æ —Å—Ü–µ–Ω–∞—Ä–∏—è–º.
- **–°–µ—Ä–≤–∏—Å—ã –∫–∞–∫ –µ–¥–∏–Ω–∏—Ü—ã –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏**: `bot/app/factories/build_services.py:1` —Å–æ–∑–¥–∞–µ—Ç –æ–±—ä–µ–∫—Ç—ã —Å–µ—Ä–≤–∏—Å–æ–≤ –∏ —Å–≤—è–∑—ã–≤–∞–µ—Ç –∏—Ö –º–µ–∂–¥—É —Å–æ–±–æ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, `SubscriptionService` –ø–æ–ª—É—á–∞–µ—Ç —Å—Å—ã–ª–∫–∏ –Ω–∞ `PanelApiService`, `YooKassaService`, `ReferralService`), —á—Ç–æ —Ä–µ–∞–ª–∏–∑—É–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω service layer –∏ –æ–±–ª–µ–≥—á–∞–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤.
- **Data Access Layer**: –∫–∞–∂–¥–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∏–º–µ–µ—Ç DAL —Å —è–≤–Ω—ã–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏ (`db/dal/subscription_dal.py:1`, `db/dal/user_dal.py:1`). DAL –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∏–∑ —Å–µ—Ä–≤–∏—Å–æ–≤/handlers, middleware `DBSessionMiddleware` –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏ rollback –ø—Ä–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏—è—Ö (`bot/middlewares/db_session.py:7`).
- **–í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –∏ webhooks**: `bot/app/web/web_server.py:10` —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –º–∞—Ä—à—Ä—É—Ç—ã Telegram, YooKassa, Tribute, CryptoPay –∏ Remnawave Panel –Ω–∞ –æ–¥–Ω–æ–º AIOHTTP-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏, –ø–µ—Ä–µ–¥–∞–≤–∞—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Äî —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ –∫–æ–º–ø–æ–∑–∏—Ü–∏—è IoC.
- **Cross-cutting middleware**: i18n, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ç–æ—Ä –ø—Ä–æ—Ñ–∏–ª–µ–π –∏ –±–∞–Ω-—á–µ–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –∫–∞–∂–¥—ã–π –∞–ø–¥–µ–π—Ç –¥–æ handler, –¥–æ–±–∞–≤–ª—è—è –¥–∞–Ω–Ω—ã–µ (`bot/middlewares/i18n.py:64`, `bot/middlewares/profile_sync.py:9`, `bot/middlewares/ban_check_middleware.py:9`). `ActionLoggerMiddleware` –ø–∏—à–µ—Ç —Å—ã—Ä—ã–µ –∞–ø–¥–µ–π—Ç—ã –≤ `message_logs` –¥–ª—è –∞—É–¥–∏—Ç–∞.
- **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –ø–æ—Ç–æ–∫–∏**: –ø–ª–∞—Ç–µ–∂–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç `asyncio.Lock` (`bot/handlers/user/payment.py:17`) –∏ –æ—á–µ—Ä–µ–¥—å —Å–æ–æ–±—â–µ–Ω–∏–π (`bot/utils/message_queue.py:15`) –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –ª–∏–º–∏—Ç–æ–≤ Telegram –∏ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏.
- **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Remnawave Panel**: `PanelApiService` (`bot/services/panel_api_service.py:16`) –∏–Ω–∫–∞–ø—Å—É–ª–∏—Ä—É–µ—Ç REST –∑–∞–ø—Ä–æ—Å—ã, `PanelWebhookService` —Ä–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ —Å–æ–±—ã—Ç–∏—è –ø–∞–Ω–µ–ª–∏ –∏ –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏—è, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ (`bot/services/panel_webhook_service.py:30`).

## üé® UI/UX –∏ —Å—Ç–∏–ª–∏–∑–∞—Ü–∏—è
- –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å—Ç—Ä–æ–∏—Ç—Å—è –∏–∑ inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä Telegram –±–µ–∑ –≤–Ω–µ—à–Ω–µ–≥–æ CSS; `bot/keyboards/inline/user_keyboards.py:12` —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –º–µ–Ω—é –∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –æ–ø—Ü–∏–∏ –æ–ø–ª–∞—Ç—ã, –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞—è—Å—å –ø–æ–¥ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é (–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –º–µ—Ç–æ–¥–æ–≤, —Ü–µ–Ω—ã, —Å—Å—ã–ª–∫–∏).
- –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —á–µ—Ä–µ–∑ JSON –∏ middleware, —è–∑—ã–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ –ë–î, Telegram-–ø—Ä–æ—Ñ–∏–ª—é –∏–ª–∏ –¥–µ—Ñ–æ–ª—Ç—É (`bot/middlewares/i18n.py:64`), –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∫–ª—é—á–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è.
- –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–æ—Å—Ç–∏–≥–∞–µ—Ç—Å—è –ª–æ–≥–∏–∫–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä –∏ —Å–æ–æ–±—â–µ–Ω–∏–π: –∫–Ω–æ–ø–∫–∏ —Å–∫—Ä—ã–≤–∞—é—Ç—Å—è –¥–ª—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥), —Å—Å—ã–ª–∫–∏ –Ω–∞ WebApp (`MenuButtonWebApp`) —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ (`bot/main_bot.py:126`).
- –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å: –∏–º–µ–Ω–∞ –∏ username –æ—á–∏—â–∞—é—Ç—Å—è –æ—Ç —Å—Å—ã–ª–æ–∫ –∏ —Ñ–∏—à–∏–Ω–≥–æ–≤—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ (`bot/utils/text_sanitizer.py:1`), –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã—Ö URL –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –∏ –æ—Ç—á—ë—Ç–∞—Ö.
- –¢–µ–º–∏–∑–∞—Ü–∏—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞ Telegram —Ç–µ–º–∞–º–∏; –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç —Å—Ç—Ä–æ–∏—Ç—Å—è –Ω–∞ —Ç–µ–∫—Å—Ç–∞—Ö –∏ —ç–º–æ–¥–∑–∏ –∏–∑ –ª–æ–∫–∞–ª–µ–π (`locales/en.json`, `locales/ru.json`). –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö a11y-–ø—Ä–∞–∫—Ç–∏–∫ (–æ–ø–∏—Å–∞–Ω–∏—è –≤–ª–æ–∂–µ–Ω–∏–π, alternate text) –Ω–µ—Ç.

## ‚úÖ –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞
- **–°—Ç–∞–Ω–¥–∞—Ä—Ç—ã**: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ª–∏–Ω—Ç–µ—Ä–æ–≤/—Ñ–æ—Ä–º–∞—Ç—Ç–µ—Ä–æ–≤ (–Ω–µ—Ç `.flake8`, `.ruff.toml`, `.pre-commit`), –æ–¥–Ω–∞–∫–æ –∫–æ–¥ –ø—Ä–∏–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è PEP 8, –∞–∫—Ç–∏–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç type hints –∏ docstring-–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.
- **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: —Ç–µ—Å—Ç–æ–≤—ã—Ö –º–æ–¥—É–ª–µ–π –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ (–ø–æ–∏—Å–∫ `*test*.py` –±–µ–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤). –ö—Ä–∏—Ç–∏—á–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã (–ø–æ–¥–ø–∏—Å–∫–∏, –æ–ø–ª–∞—Ç—ã) –Ω–µ –ø–æ–∫—Ä—ã—Ç—ã unit/integration —Ç–µ—Å—Ç–∞–º–∏ ‚Äî –≤—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ —Ä–µ–≥—Ä–µ—Å—Å–∏–π.
- **–¢–∏–ø–∏–∑–∞—Ü–∏—è**: `pydantic` –º–æ–¥–µ–ª–∏ –∏ —Å–∏–≥–Ω–∞—Ç—É—Ä—ã —Ñ—É–Ω–∫—Ü–∏–π —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω—ã, –Ω–æ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —É—á–∞—Å—Ç–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–ª–æ–≤–∞—Ä–∏ –≤ DAL) –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç `Dict[str, Any]`, —á—Ç–æ —É—Å–ª–æ–∂–Ω—è–µ—Ç —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ (`bot/services/subscription_service.py:120`).
- **–ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î**: –≤–º–µ—Å—Ç–æ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–≥–æ Alembic –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞—Å—Ç–æ–º–Ω—ã–π `run_simple_migrations` –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫ –±–µ–∑ –∫–æ–Ω—Ç—Ä–æ–ª—è —Å—Ö–µ–º ( `db/migrator.py:5` ). –≠—Ç–æ –æ–±–ª–µ–≥—á–∞–µ—Ç –¥–µ–ø–ª–æ–π, –Ω–æ –æ–ø–∞—Å–Ω–æ –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π.
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ø–æ–∫—Ä—ã–≤–∞–µ—Ç –≤—Å–µ –∫–ª—é—á–µ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏. `NotificationService` (`bot/services/notification_service.py:1`) –∏ –≤–µ–±—Ö—É–∫–∏ –ø–∏—à—É—Ç –ø–æ–¥—Ä–æ–±–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è —Å–ª–µ–¥–∏—Ç—å –∑–∞ —É—Ç–µ—á–∫–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –ª–æ–≥–∞—Ö.
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å–æ–¥–µ—Ä–∂–∏—Ç —Ä–µ–∞–ª—å–Ω—ã–π `BOT_TOKEN` –≤ `stack.env:1` ‚Äî –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É–¥–∞–ª–∏—Ç—å —Å–µ–∫—Ä–µ—Ç –∏ –ø–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–∫–µ–Ω. –•—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –ø—Ä–∏–º–µ—Ä-—Ñ–∞–π–ª–∞—Ö –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º–æ. (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)

## üîß –ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- **Dispatcher orchestration** (`bot/app/controllers/dispatcher_controller.py:14`): –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –±–æ—Ç–∞, –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—é –∏ middleware-—Ü–µ–ø–æ—á–∫—É, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—è –µ–¥–∏–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤.
  ```python
  def build_dispatcher(settings: Settings, async_session_factory: sessionmaker) -> tuple[Dispatcher, Bot, Dict]:
      storage = MemoryStorage()
      default_props = DefaultBotProperties(parse_mode=ParseMode.HTML)
      bot = Bot(token=settings.BOT_TOKEN, default=default_props)

      dp = Dispatcher(storage=storage, settings=settings, bot_instance=bot)

      i18n_instance = get_i18n_instance(path="locales", default=settings.DEFAULT_LANGUAGE)
      dp["i18n_instance"] = i18n_instance
      dp["async_session_factory"] = async_session_factory

      dp.update.outer_middleware(DBSessionMiddleware(async_session_factory))
      dp.update.outer_middleware(I18nMiddleware(i18n=i18n_instance, settings=settings))
      dp.update.outer_middleware(ProfileSyncMiddleware())
      dp.update.outer_middleware(BanCheckMiddleware(settings=settings, i18n_instance=i18n_instance))
      dp.update.outer_middleware(ActionLoggerMiddleware(settings=settings))
      return dp, bot, {"i18n_instance": i18n_instance}
  ```
- **–ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏** (`bot/services/subscription_service.py:431`): –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –Ω–∞–ª–∏—á–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –ø–∞–Ω–µ–ª–∏ –∏ –≤–∞–ª–∏–¥–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏ –ø–µ—Ä–µ–¥ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ–º, –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—è —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –º–µ–∂–¥—É –ª–æ–∫–∞–ª—å–Ω—ã–º –ë–î –∏ Remnawave.
  ```python
        db_user = await user_dal.get_user_by_id(session, user_id)
        if not db_user:
            logging.error(
                f"User {user_id} not found in DB for paid subscription activation."
            )
            return None

        panel_user_uuid, panel_sub_link_id, panel_short_uuid, panel_user_created_now = (
            await self._get_or_create_panel_user_link_details(session, user_id, db_user)
        )

        if not panel_user_uuid or not panel_sub_link_id:
            logging.error(
                f"Failed to ensure panel user for TG {user_id} during paid subscription."
            )
            return None
  ```
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ CryptoPay –≤–µ–±—Ö—É–∫–∞** (`bot/services/crypto_pay_service.py:162`): —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç –æ–ø–ª–∞—Ç—É, –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É –∏ –Ω–∞—á–∏—Å–ª—è–µ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –±–æ–Ω—É—Å—ã, –∏—Å–ø–æ–ª—å–∑—É—è —Å–µ—Ä–≤–∏—Å—ã –∏ i18n –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
  ```python
        async with async_session_factory() as session:
            try:
                await payment_dal.update_provider_payment_and_status(
                    session,
                    payment_db_id,
                    str(invoice.invoice_id),
                    "succeeded",
                )
                activation = await subscription_service.activate_subscription(
                    session,
                    user_id,
                    months,
                    float(invoice.amount),
                    payment_db_id,
                    provider="cryptopay",
                )
                referral_bonus = await referral_service.apply_referral_bonuses_for_payment(
                    session,
                    user_id,
                    months,
                    current_payment_db_id=payment_db_id,
                    skip_if_active_before_payment=False,
                )
                await session.commit()
            except Exception as e:
                await session.rollback()
                logging.error(f"Failed to process CryptoPay invoice: {e}", exc_info=True)
                return
  ```
- **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–∞–Ω–µ–ª–∏ –æ —Å–∫–æ—Ä–æ–º –æ–∫–æ–Ω—á–∞–Ω–∏–∏** (`bot/services/panel_webhook_service.py:186`): —Å–≤—è–∑—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –ø–∞–Ω–µ–ª–∏ —Å –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –∏ —Ç–æ—á–µ—á–Ω—ã–º–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏, –≤–∫–ª—é—á–∞—è –ø–æ–ø—ã—Ç–∫—É –∞–≤—Ç–æ—Å–ø–∏—Å–∞–Ω–∏—è —á–µ—Ä–µ–∑ YooKassa.
  ```python
        if event_name in EVENT_MAP:
            days_left, msg_key = EVENT_MAP[event_name]
            if days_left == 1:
                try:
                    subscription_service = getattr(self, "subscription_service", None)
                    if subscription_service:
                        async with self.async_session_factory() as session:
                            from db.dal import subscription_dal
                            sub = await subscription_dal.get_active_subscription_by_user_id(session, user_id)
                            if sub and sub.auto_renew_enabled and sub.provider != 'tribute':
                                try:
                                    ok = await subscription_service.charge_subscription_renewal(session, sub)
                                    if ok:
                                        await session.commit()
                                        return
                                except Exception:
                                    await session.rollback()
                                    logging.exception("Auto-renew attempt (24h) failed")
                except Exception:
                    logging.exception("Auto-renew trigger (24h) failed pre-check")
  ```

## üìã –í—ã–≤–æ–¥—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
- –ü—Ä–æ–µ–∫—Ç –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –∑—Ä–µ–ª—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É —Å —á—ë—Ç–∫–∏–º —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º —Å–ª–æ—ë–≤, –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º —Å—Ç–µ–∫–æ–º –∏ –±–æ–≥–∞—Ç–æ–π –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–æ–π; –ø–æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω –Ω–∞ senior-—É—Ä–æ–≤–µ–Ω—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞.
- –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã: —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è, –ø—Ä–æ–¥—É–º–∞–Ω–Ω—ã–µ middleware, –≥–ª—É–±–æ–∫–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Remnawave Panel –∏ –º—É–ª—å—Ç–∏–∫–∞–Ω–∞–ª—å–Ω—ã–º–∏ –ø–ª–∞—Ç–µ–∂–∞–º–∏, –º–µ—Ö–∞–Ω–∏–∑–º—ã –∞—É–¥–∏—Ç–∞ –∏ –∑–∞—â–∏—Ç—ã (sanitize, action logs, rate limiting –æ—á–µ—Ä–µ–¥—å—é —Å–æ–æ–±—â–µ–Ω–∏–π).
- –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –∑–æ–Ω—ã —É–ª—É—á—à–µ–Ω–∏—è: –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ç–µ—Å—Ç–æ–≤ –∏ –ª–∏–Ω—Ç–∏–Ω–≥–∞, —Ä—É—á–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –≤–Ω–µ–¥—Ä–∏—Ç—å Alembic), —É—Ç–µ—á–∫–∏ —Å–µ–∫—Ä–µ—Ç–æ–≤ –≤ –ø—Ä–∏–º–µ—Ä–∞—Ö, –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ (>800 —Å—Ç—Ä–æ–∫ –≤ `subscription_service.py`).
- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É:
1) —É–±—Ä–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã –∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –∫–ª—é—á–∏ (—É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ);
2) –≤–Ω–µ–¥—Ä–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –ø–∏—Ä–∞–º–∏–¥—É (unit –¥–ª—è DAL/—Å–µ—Ä–≤–∏—Å–æ–≤, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –¥–ª—è –ø–ª–∞—Ç–µ–∂–µ–π —Å –º–æ–∫–∞–º–∏), –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ª–∏–Ω—Ç–µ—Ä—ã –∏ pre-commit (–≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Ç–ª–æ–∂–µ–Ω–æ);
3) –¥–µ–∫–æ–º–ø–æ–∑–∏—Ä–æ–≤–∞—Ç—å –∫—Ä—É–ø–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã (–ø–æ–¥–ø–∏—Å–∫–∏/–ø–∞–Ω–µ–ª—å) –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—É–±–ª–∏—á–Ω—ã–µ –º–µ—Ç–æ–¥—ã (–≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Ç–ª–æ–∂–µ–Ω–æ);
4) –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ —É–ø—Ä–∞–≤–ª—è–µ–º—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –∏ –¥–æ–±–∞–≤–∏—Ç—å health-check–∏ –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π. (–≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Ç–ª–æ–∂–µ–Ω–æ)
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —Å—Ç–æ–∏—Ç —Ä–∞—Å—à–∏—Ä–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (–º–µ—Ç—Ä–∏–∫–∏ –æ—á–µ—Ä–µ–¥–∏, —á–∞—Å—Ç–æ—Ç–∞ –æ—à–∏–±–æ–∫ –ø–ª–∞—Ç–µ–∂–µ–π), —Ñ–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å UI-–∫–æ–Ω—Ç–µ–Ω—Ç (–¥–∏–∑–∞–π–Ω-–≥–∞–π–¥ –¥–ª—è –ª–æ–∫–∞–ª–µ–π) –∏ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–∏ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—à–∞–≥–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ `/sync`). (–≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Ç–ª–æ–∂–µ–Ω–æ)
