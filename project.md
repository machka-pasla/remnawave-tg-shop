# –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã –¢–µ–ª–µ–≥—Ä–∞–º–º‚Äê–±–æ—Ç–∞: Altered_Internet_bot

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
- –ò—Å—Ç–æ—á–Ω–∏–∫ –¥–µ—Ä–µ–≤–∞: `structure.txt` (–∞–∫—Ç—É–∞–ª—å–Ω–æ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è); —Å–ª—É–∂–µ–±–Ω—ã–µ –∫–∞—Ç–∞–ª–æ–≥–∏ `.github` –∏ `.venv` –∏—Å–∫–ª—é—á–µ–Ω—ã.
```text
Altered_Internet_bot
‚îú‚îÄ bot/
‚îÇ  ‚îú‚îÄ app/ (dispatcher, web-server bootstrap)
‚îÇ  ‚îú‚îÄ handlers/ (user, admin, inline —Å—Ü–µ–Ω–∞—Ä–∏–∏)
‚îÇ  ‚îú‚îÄ middlewares/
‚îÇ  ‚îú‚îÄ services/
‚îÇ  ‚îú‚îÄ states/
‚îÇ  ‚îî‚îÄ utils/
‚îú‚îÄ config/settings.py
‚îú‚îÄ db/
‚îÇ  ‚îú‚îÄ dal/
‚îÇ  ‚îú‚îÄ models.py
‚îÇ  ‚îî‚îÄ migrator.py
‚îú‚îÄ locales/
‚îú‚îÄ main.py
‚îú‚îÄ Dockerfile
‚îú‚îÄ docker-compose*.yml
‚îú‚îÄ requirements.txt
‚îî‚îÄ project.md
```
- `bot/` ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π —Å–ª–æ–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ –Ω–∞ aiogram: –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞ (`bot/app/controllers/dispatcher_controller.py:19`), —Ñ–∞–±—Ä–∏–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤ (`bot/app/factories/build_services.py:18`), —Ä–æ—É—Ç–µ—Ä—ã (`bot/routers.py:10`), –Ω–∞–±–æ—Ä middlewares (`bot/middlewares/*`) –∏ –¥–æ–º–µ–Ω–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏.
- `bot/services/` ‚Äî –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ (Remnawave API, YooKassa, CryptoPay, FreeKassa, Telegram Stars –∏ —Ç.–¥.), –Ω–æ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ —Å–µ—Ä–≤–∏—Å–æ–≤ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç `Bot`, `Settings`, `JsonI18n`, —á—Ç–æ —Å–≤—è–∑—ã–≤–∞–µ—Ç –∏—Ö —Å —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–æ–º.
- `bot/utils/` ‚Äî —Å–ª—É–∂–µ–±–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã (–æ—á–µ—Ä–µ–¥—å —Å–æ–æ–±—â–µ–Ω–∏–π, —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–∞–Ω–∏—Ç–∞–π–∑–µ—Ä—ã, ecdc_* –¥–ª—è —Ñ–æ—Ä–º–∞—Ç-—Å–æ—Ö—Ä–∞–Ω—è—é—â–µ–≥–æ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è TID/TGID; –ø–æ—Å–ª–µ–¥–Ω—è—è –≥—Ä—É–ø–ø–∞ –ø–æ–∫–∞ –Ω–µ –∑–∞–¥–µ–π—Å—Ç–≤–æ–≤–∞–Ω–∞ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –∫–æ–¥–µ).
- `config/settings.py` ‚Äî –º–æ–Ω–æ–ª–∏—Ç–Ω–∞—è pydantic-–º–æ–¥–µ–ª—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (~400 —Å—Ç—Ä–æ–∫) —Å computed-field‚Äô–∞–º–∏ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π; ECDC-–ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ `.env.example` –∑–¥–µ—Å—å –ø–æ–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç, –ø–æ—ç—Ç–æ–º—É –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è.
- `db/` ‚Äî SQLAlchemy –º–æ–¥–µ–ª–∏ (`db/models.py:12` –∏ –¥–∞–ª–µ–µ), DAL-—Å–ª–æ–π, –ø—Ä–æ—Å—Ç–µ–π—à–∏–π –º–∏–≥—Ä–∞—Ç–æ—Ä (`db/migrator.py:23`) –∏ —É—Ç–∏–ª–∏—Ç—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π (`db/database_setup.py`).
- `locales/` ‚Äî JSON-—Å–ª–æ–≤–∞—Ä—å —Å–æ–æ–±—â–µ–Ω–∏–π (ru/en), –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞—Å—Ç–æ–º–Ω—ã–º `JsonI18n` (`bot/middlewares/i18n.py:118`).
- –ö–æ—Ä–µ–Ω—å: `main.py` (–≤—Ö–æ–¥–Ω–∞—è —Ç–æ—á–∫–∞), `Dockerfile` (Python 3.11 slim, –¥–≤—É—Ö—Å—Ç–∞–¥–∏–π–Ω–∞—è —Å–±–æ—Ä–∫–∞), `docker-compose.yml` (–±–æ—Ç + PostgreSQL 17), `requirements.txt`, –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (`README.md`).

## üõ† –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫
| –°–ª–æ–π | –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ / –≤–µ—Ä—Å–∏–∏ | –ò—Å—Ç–æ—á–Ω–∏–∫ –∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
| --- | --- | --- |
| Runtime | Python 3.11 | `Dockerfile` –±–∞–∑–∏—Ä—É–µ—Ç—Å—è –Ω–∞ `python:3.11-slim`; –ª–æ–∫–∞–ª—å–Ω–æ –æ–∂–∏–¥–∞–µ—Ç—Å—è —Ç–æ—Ç –∂–µ —Ä–∞–Ω—Ç–∞–π–º. |
| –ë–æ—Ç-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫ | `aiogram==3.21.0` | `requirements.txt`; –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è, FSM, middlewares. |
| –í–µ–±/–≤–µ–±—Ö—É–∫–∏ | `aiohttp==3.12.14` | `bot/app/web/web_server.py` –ø–æ–¥–Ω–∏–º–∞–µ—Ç –≤–µ–±-—Å–µ—Ä–≤–µ—Ä –¥–ª—è Telegram –∏ –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö –≤–µ–±—Ö—É–∫–æ–≤. |
| –ù–∞—Å—Ç—Ä–æ–π–∫–∏ | `pydantic==2.7.1`, `pydantic_settings`, `python-dotenv==1.0.1` | `config/settings.py`, `main.py:5` –ø–æ–¥–≥—Ä—É–∂–∞–µ—Ç `.env`. |
| –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö | `SQLAlchemy[asyncio]==2.0.29`, `asyncpg==0.29.0`, `alembic==1.13.1` (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è) | DAL –∏ –º–æ–¥–µ–ª–∏ –≤ `db/`; –º–∏–≥—Ä–∞—Ç–æ—Ä –∫–∞—Å—Ç–æ–º–Ω—ã–π, alembic –≤ requirements, –Ω–æ –≤ –∫–æ–¥–µ –Ω–µ—Ç. |
| –ü–ª–∞—Ç–µ–∂–∏ | `yookassa==3.5.0`, `aiocryptopay==0.4.8`, –∫–∞—Å—Ç–æ–º–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã FreeKassa/Tribute | –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –≤ `bot/services/*_service.py`. |
| –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ | Docker / docker-compose, PostgreSQL 17, message queue | `docker-compose.yml`, `bot/utils/message_queue.py:18`. |
| –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è | JSON-—Ñ–∞–π–ª—ã + –∫–∞—Å—Ç–æ–º–Ω—ã–π `JsonI18n` | `bot/middlewares/i18n.py`. |
| –ü—Ä–æ—á–µ–µ | `pycountry`, `aiohttp`, `logging` | –£—Ç–∏–ª–∏—Ç–∞—Ä–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤ —Å–µ—Ä–≤–∏—Å–∞—Ö. |

–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Ñ–æ—Ä–º–∞—Ç-—Å–æ—Ö—Ä–∞–Ω—è—é—â–µ–µ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ (`bot/utils/ecdc_core.py`, `bot/utils/ecdc_api.py`), CLI (`bot/utils/ecdc_cli.py`), –Ω–æ –æ–Ω–∏ –ø–æ–∫–∞ –Ω–µ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ —Ä–∞–±–æ—á–∏–π –ø–æ—Ç–æ–∫.

## üèó –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
**–°–ª–æ–∏ –∏ –∑–∞–ø—É—Å–∫.** `main.py:1` –∑–∞–≥—Ä—É–∂–∞–µ—Ç `.env`, —Å–æ–∑–¥–∞–µ—Ç `Settings`, –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç –¥–≤–∏–∂–æ–∫/—Å–µ—Å—Å–∏–∏ (`db/database_setup.py:14`), –∑–∞—Ç–µ–º –≤—ã–∑—ã–≤–∞–µ—Ç `run_bot` (`bot/main_bot.py:231`). –î–∞–ª—å—à–µ —Å—Ç—Ä–æ–∏—Ç—Å—è Dispatcher (`bot/app/controllers/dispatcher_controller.py:19`) —Å –ø–∞–º—è—Ç—å—é –≤ RAM (`MemoryStorage`) –∏ —Ü–µ–ø–æ—á–∫–æ–π middlewares, –ø–æ—Å–ª–µ —á–µ–≥–æ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è —Å–µ—Ä–≤–∏—Å—ã (`bot/app/factories/build_services.py:18`), –∫–æ—Ä–Ω–µ–≤–æ–π —Ä–æ—É—Ç–µ—Ä (`bot/routers.py:10`) –∏ aiohttp-—Å–µ—Ä–≤–µ—Ä –≤–µ–±—Ö—É–∫–æ–≤ (`bot/app/web/web_server.py:8`).

**–°–µ—Ä–≤–∏—Å—ã –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏.** –°–µ—Ä–≤–∏—Å—ã (subscription/referral/notification/–ø–ª–∞—Ç–µ–∂–∏) –ø–æ–ª—É—á–∞—é—Ç `Bot`, `Settings`, `JsonI18n`, `sessionmaker`. –≠—Ç–æ —É–ø—Ä–æ—â–∞–µ—Ç DI –≤ aiogram, –Ω–æ tightly-couples –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É —Å Telegram API. –ü—Ä–∏–º–µ—Ä: `SubscriptionService` —Ö—Ä–∞–Ω–∏—Ç —Å—Å—ã–ª–∫—É –Ω–∞ `Bot` –∏ –≤—ã–∑—ã–≤–∞–µ—Ç `send_message` –ø—Ä—è–º–æ –∏–∑ –±–∏–∑–Ω–µ—Å-–º–µ—Ç–æ–¥–æ–≤ (`bot/services/subscription_service.py:900`), `ReferralService` –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (`bot/services/referral_service.py:120`), `NotificationService` —É–ø—Ä–∞–≤–ª—è–µ—Ç –æ—á–µ—Ä–µ–¥—å—é (`bot/services/notification_service.py:24`). –î–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –¥–æ –≤—Ç–æ—Ä–æ–≥–æ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –æ—Ç–¥–µ–ª–∏—Ç—å —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–µ –∞–¥–∞–ø—Ç–µ—Ä—ã –æ—Ç —Å–µ—Ä–≤–∏—Å–æ–≤.

**–¢–æ—á–∫–∏ –≤—Ö–æ–¥–∞/–≤—ã—Ö–æ–¥–∞ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤.** –ë–æ—Ç —á–∏—Ç–∞–µ—Ç `from_user.id` –≤–æ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö (`bot/handlers/user/start.py:304`, `bot/handlers/user/referral.py:62`, `bot/handlers/user/subscription/core.py:101`, `bot/handlers/user/promo_user.py:64`, `bot/handlers/inline_mode.py:29`), –≤ middlewares (`bot/middlewares/channel_subscription.py:55`, `bot/middlewares/action_logger_middleware.py:35`, `bot/middlewares/ban_check_middleware.py:25`), –≤ –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö –≤–µ–±—Ö—É–∫–∞—Ö (`bot/services/crypto_pay_service.py:143`, `bot/services/freekassa_service.py:339`, `bot/services/tribute_service.py:186`, `bot/services/stars_service.py:118`), –∞ —Ç–∞–∫–∂–µ –∏–∑ –≤–Ω–µ—à–Ω–∏—Ö —Å–æ–±—ã—Ç–∏–π –ø–∞–Ω–µ–ª–∏ (`bot/services/panel_webhook_service.py:170`). –í—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∫–∞–∫ `BigInteger` –≤ `users.user_id` (`db/models.py:15`) –∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ –¥–æ—á–µ—Ä–Ω–∏—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö/–∏–Ω–¥–µ–∫—Å–∞—Ö: `subscriptions.user_id` (`db/models.py:60`), `payments.user_id` (`db/models.py:91`), `message_logs.user_id/target_user_id` (`db/models.py:196`), `ad_attributions.user_id` (`db/models.py:229`). –í–Ω–µ—à–Ω–∏–π –≤—ã–≤–æ–¥ —Ä–µ–∞–ª—å–Ω–æ–≥–æ TID –∏–¥—ë—Ç –≤:
Telegram API (—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã) ‚Äî –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã, `NotificationService`, `message_queue` (`bot/utils/message_queue.py:102`);
Remnawave API ‚Äî `panel_service.create/update_user` (`bot/services/panel_api_service.py:332`, `bot/services/panel_api_service.py:406`) –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞—é—Ç `telegramId` –Ω–∞—Ä—É–∂—É;
–ü–ª–∞—Ç–µ–∂–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ ‚Äî YooKassa (`bot/handlers/user/subscription/payments.py:303` ‚Üí `yookassa_service.create_payment`), CryptoPay (`bot/services/crypto_pay_service.py:128`), Tribute (`bot/services/tribute_service.py:152`), FreeKassa (`bot/services/freekassa_service.py:339`), Telegram Stars (`bot/services/stars_service.py:98`);
–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ/–º–µ—Ç—Ä–∏–∫–∏ ‚Äî `ActionLoggerMiddleware`, `NotificationService` (`bot/services/notification_service.py:109`), `db/message_logs`.
–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π TID –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤–æ –≤—Å–µ—Ö —Å–ª–æ—è—Ö, –∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Ç—Ä–µ–±—É–µ—Ç —Ç–æ—á–µ—á–Ω–æ–π –ø–æ–¥–º–µ–Ω—ã + –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ Telegram/Remnawave.

**–•—Ä–∞–Ω–∏–ª–∏—â–µ –∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ.** DAL –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω –æ—Ç aiogram, –∏–º–µ–Ω–∞ –º–µ—Ç–æ–¥–æ–≤ —è–≤–Ω—ã–µ (`db/dal/user_dal.py`, `db/dal/subscription_dal.py`, `db/dal/payment_dal.py`). –û–¥–Ω–∞–∫–æ —Å–µ—Ä–≤–∏—Å—ã –Ω–µ —Ñ–æ—Ä–º–∏—Ä—É—é—Ç –æ—Ç—á—ë—Ç–ª–∏–≤—ã–π application-layer API: –Ω–∞–ø—Ä–∏–º–µ—Ä, `ReferralService` –¥–µ—Ä–≥–∞–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –∏–∑ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤, –∞ `SubscriptionService` –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∏ –¥–æ–º–µ–Ω–Ω—É—é –ª–æ–≥–∏–∫—É, –∏ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ –ø–∞–Ω–µ–ª–∏, –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è. –í `db/models.py:274`‚Äì`db/models.py:341` —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è ¬´Referral Club¬ª (RefClTokens/RefInvites/RefList), –Ω–æ –∫–æ–¥ –∏—Ö –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç ‚Äî –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –±–∞–∑–∞ –¥–ª—è —Ä–µ—Ñ–µ—Ä–∞–ª–∫–∏ v2.

**–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞–º.**
–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç –∏ –¥–æ–º–µ–Ω –Ω–µ —Ä–∞–∑–¥–µ–ª–µ–Ω—ã: –±–∏–∑–Ω–µ—Å-–º–µ—Ç–æ–¥—ã –≤—ã–∑—ã–≤–∞—é—Ç `Bot` –∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç `JsonI18n`; DTO/–≤–∞–ª–∏–¥–∞—Ç–æ—Ä—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç ‚Äî –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –±–µ—Ä—É—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –∏–∑ Telegram update –∏ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ DAL; –µ–¥–∏–Ω—ã–π API —Å–ª–æ–π (REST/GraphQL) –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç. –î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –≤—ã–¥–µ–ª–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã –æ—Ç Telegram-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤—ã–Ω–µ—Å—Ç–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ —Å–æ–±—ã—Ç–∏—è), –≤–≤–µ—Å—Ç–∏ –∞–¥–∞–ø—Ç–µ—Ä –¥–ª—è UID‚ÜîTID.

**–°—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ —Ä–∏—Å–∫–∏.**
–ü–æ–ª–∏–≤–∞–Ω–∏–µ PII: `ActionLoggerMiddleware` –∏ `NotificationService` –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç —Ä–µ–∞–ª—å–Ω—ã–µ TID –≤ –∞–¥–º–∏–Ω-—á–∞—Ç—ã/–ª–æ–≥–∏. `LOG_CHAT_ID` (–≥—Ä—É–ø–ø–∞) —Ç–æ–∂–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –∫–∞–∫ tgid –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö. `Structure.txt` —É–ø–æ–º–∏–Ω–∞–µ—Ç ECDC, –Ω–æ `Settings` –µ–≥–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç ‚Äî –∑–Ω–∞—á–∏—Ç, —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ. –ú–∏–≥—Ä–∞—Ç–æ—Ä —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏—à—å –æ–¥–Ω—É –º–∏–≥—Ä–∞—Ü–∏—é (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–µ–π –∫–∞–Ω–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫) –∏ –Ω–µ –ø–æ–∫—Ä—ã–≤–∞–µ—Ç –±—É–¥—É—â–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (UID, —Ä–µ—Ñ–µ—Ä–∞–ª–∫–∞). –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç —Ç–µ—Å—Ç—ã, –ø–æ—ç—Ç–æ–º—É –ª—é–±–∞—è –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤/—Ä–µ–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ‚Äî –∑–æ–Ω–∞ –ø–æ–≤—ã—à–µ–Ω–Ω–æ–≥–æ —Ä–∏—Å–∫–∞.

## üé® UX –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –±–æ—Ç–∞
–°—Ü–µ–Ω–∞—Ä–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å—Ç—Ä–æ—è—Ç—Å—è –≤–æ–∫—Ä—É–≥ `/start`, –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é –∏ —Ü–µ–ø–æ—á–µ–∫ –∫–æ–ª–ª–±–µ–∫–æ–≤. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ –∫–∞–Ω–∞–ª—É –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ –º–µ–¥–∏–∞—Ç–æ—Ä–µ (`ChannelSubscriptionMiddleware`), –±–∞–Ω ‚Äì –≤ `BanCheckMiddleware`. –ü—Ä–æ–º–æ–∫–æ–¥—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç FSM (`UserPromoStates`), –æ—Å—Ç–∞–ª—å–Ω–æ–µ ‚Äî stateless callbacks. –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è ‚Äî —á–µ—Ä–µ–∑ `JsonI18n` —Å –∫–ª—é—á–∞–º–∏ –∏–∑ `locales/*.json`.

| –ö–æ–º–∞–Ω–¥–∞/—Å–æ–±—ã—Ç–∏–µ | Handler | –°–æ—Å—Ç–æ—è–Ω–∏–µ/–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ | –§–∞–π–ª |
| --- | --- | --- | --- |
| `/start`, deep-link (`ref_*`, `promo_*`, –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π `start` –ø–∞—Ä–∞–º–µ—Ç—Ä) | `start_command_handler` | –û—á–∏—Å—Ç–∫–∞ FSM, –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ, `get_main_menu_inline_keyboard` | bot/handlers/user/start.py:304 |
| `main_action:subscribe` | `display_subscription_options` | –ú–µ–Ω—é —Ç–∞—Ä–∏—Ñ–æ–≤ `get_subscription_options_keyboard` | bot/handlers/user/subscription/core.py:20 |
| `subscribe_period:{months}` | `select_subscription_period_callback_handler` | –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –æ–ø–ª–∞—Ç—ã `get_payment_method_keyboard` | bot/handlers/user/subscription/payments.py:303 |
| `main_action:referral` / `referral_action:share_message` | `referral_command_handler` / `referral_action_handler` | `get_referral_link_keyboard` | bot/handlers/user/referral.py:16 |
| `main_action:apply_promo` + –≤–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞ | `prompt_promo_code_input` ‚Üí `process_promo_code_input` | FSM `UserPromoStates`, `get_back_to_main_menu_markup` / `get_connect_and_main_keyboard` | bot/handlers/user/promo_user.py:43 |
| `main_action:request_trial` / `trial_action:confirm_activate` | `request_trial_confirmation_handler` / `confirm_activate_trial_handler` | –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ `get_trial_confirmation_keyboard`, –∑–∞—Ç–µ–º `get_connect_and_main_keyboard` | bot/handlers/user/trial_handler.py:23 |
| `/connect` | `connect_command_handler` | –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç `my_subscription_command_handler` –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –ø–æ–¥–ø–∏—Å–∫–∏ | bot/handlers/user/subscription/core.py:556 |
| Inline query | `inline_query_handler` | –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–µ—Ñ–µ—Ä–∞–ª–∫–∏ –∏ –∞–¥–º–∏–Ω-—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ | bot/handlers/inline_mode.py:24 |

**UX-–Ω–∞–±–ª—é–¥–µ–Ω–∏—è –∏ –±—ã—Å—Ç—Ä—ã–µ —É–ª—É—á—à–µ–Ω–∏—è.**
- –î–æ–±–∞–≤–∏—Ç—å —è–≤–Ω—ã–π fallback –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ `bot_username` –∏ –∏–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Å–µ–π—á–∞—Å –≤ `referral_command_handler` –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫—É—é –æ—à–∏–±–∫—É).
- –£–ø—Ä–æ—Å—Ç–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –ø–æ–ø–∞–¥–∞–Ω–∏–µ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é: –º–Ω–æ–≥–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø—ã—Ç–∞—é—Ç—Å—è `edit_text`, –Ω–æ –ø–∞–¥–∞—é—Ç –∏ –¥—É–±–ª–∏—Ä—É—é—Ç —Å–æ–æ–±—â–µ–Ω–∏—è; —Å—Ç–æ–∏—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É —á–µ—Ä–µ–∑ `send_main_menu` –∏ —É–¥–∞–ª—è—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã.
- –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –≤ –ø—Ä–æ–º–æ–∫–æ–¥–∞—Ö/–ø–ª–∞—Ç–µ–∂–∞—Ö –º–µ—Å—Ç–∞–º–∏ –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ/—Ä—É—Å—Å–∫–∏–µ; —Å—Ç–æ–∏—Ç —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á–∏ (`locales/en.json`, `locales/ru.json`).
- –ö–∞–Ω–∞–ª—å–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (`ChannelSubscriptionMiddleware`) –Ω–µ –ø—Ä—è—á–µ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ ID –∏ –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –ø–æ —Å—Å—ã–ª–∫–∞–º). –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å user-friendly –ø–æ–¥—Å–∫–∞–∑–∫—É –∏ throttle.

**–¢–æ—á–∫–∏ –≤—Ä–µ–∑–∫–∏ –¥–ª—è –Ω–æ–≤—ã—Ö —Ñ–∏—á.**
- Post-/start –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è: –¥–æ–±–∞–≤–∏—Ç—å —Ñ–∏—á–µ—Ñ–ª–∞–≥ –∏ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —à–∞–≥ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞–Ω–∞–ª–∞ –ø–µ—Ä–µ–¥ `send_main_menu` (`bot/handlers/user/start.py:430`) –∏ –≤ `main_action_callback_handler` (`bot/handlers/user/start.py:627`) ‚Äî –µ—Å–ª–∏ guard –∞–∫—Ç–∏–≤–µ–Ω –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø—Ä–æ—à—ë–ª challenge, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—Ç—å –≤ –Ω–æ–≤—ã–π FSM.
- –†–µ—Ñ–µ—Ä–∞–ª–∫–∞ v2: –æ–±–µ—Ä–Ω—É—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Å—Å—ã–ª–æ–∫ –≤ –Ω–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å –Ω–∞ –±–∞–∑–µ `RefCl*` —Ç–∞–±–ª–∏—Ü; —Ç–æ—á–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏/–ø—Ä–æ–≤–µ—Ä–∫–∏ ‚Äî `start_command_handler` (–ø–∞—Ä—Å–∏–Ω–≥ `start`), `referral_command_handler`, –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π (`ReferralService.apply_referral_bonuses_for_payment`).
- UID ‚Üî TID –∞–¥–∞–ø—Ç–µ—Ä: –∏–Ω—Å—Ç–∞–Ω—Ü–∏—Ä–æ–≤–∞—Ç—å `EcdcService` –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ (`build_core_services`) –∏ –ø—Ä–æ–∫–∏–Ω—É—Ç—å —á–µ—Ä–µ–∑ `dispatcher`/context, –∑–∞–º–µ–Ω–∏–≤ –ø—Ä—è–º—ã–µ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ `from_user.id` –∏–ª–∏ –¥–æ–ø–æ–ª–Ω—è—è –∏—Ö –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ–º.

## ‚úÖ –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö –∏ –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
**Users / –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã.** `db/models.py:12` –æ–±—ä—è–≤–ª—è–µ—Ç `users` —Å PK `user_id` (BigInteger), —Å—Å—ã–ª–∫–∞–º–∏ `referred_by_id`, `panel_user_uuid`, –ø—Ä–∏–∑–Ω–∞–∫–∞–º–∏ –∫–∞–Ω–∞–ª—å–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –í—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã (subscriptions/payments/promo/message_logs/ad_attributions) –∏—Å–ø–æ–ª—å–∑—É—é—Ç `user_id` –∫–∞–∫ FK. –î–ª—è UID –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å —Å–∏–º–º–µ—Ç—Ä–∏—á–Ω—É—é –∫–æ–ª–æ–Ω–∫—É (VARCHAR(14) + —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å) –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –¥–≤–æ–π–Ω—É—é –∑–∞–ø–∏—Å—å.

**–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã.** –í `db/models.py:274`‚Äì`db/models.py:341` —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã `RefClTokens`, `RefInvites`, `RefList`, `RefClub` —Å —Ñ–æ—Ä–º–∞—Ç–Ω—ã–º–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏ `UID_REGEX`. –û–Ω–∏ –ø–æ–∫–∞ –Ω–µ —Ñ–∏–≥—É—Ä–∏—Ä—É—é—Ç –≤ DAL/handlers. –ò—Ö –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–∫ –æ—Å–Ω–æ–≤—É –¥–ª—è –Ω–æ–≤–æ–π —Ä–µ—Ñ–µ—Ä–∞–ª–∫–∏ (CL —Ç–æ–∫–µ–Ω—ã, –ª–∏—Å—Ç—ã, –∫–ª—É–±–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã) –≤–º–µ—Å—Ç–æ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤—ã—Ö —Ç–∞–±–ª–∏—Ü.

**–ü–ª–∞—Ç–µ–∂–∏ –∏ –±–∏–ª–ª–∏–Ω–≥.** `payments` (`db/models.py:87`), `user_billing` (`db/models.py:120`), `user_payment_methods` (`db/models.py:133`) –æ—Ç—Ä–∞–∂–∞—é—Ç —Ç–µ–∫—É—â—É—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å YooKassa/Stars. –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–µ–π —Å–æ–¥–µ—Ä–∂–∞—Ç `user_id` (plain). –ù—É–∂–Ω–æ –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏–µ UID –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏, –Ω–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞—Ç–Ω–æ –¥–ª—è Telegram/Remnawave.

**Action logs.** –¢–∞–±–ª–∏—Ü–∞ `message_logs` (`db/models.py:193`) —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç `user_id`, `target_user_id`, —Å—ã—Ä–æ–π update. –î–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –ø–æ PII –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–æ–±–∞–≤–∏—Ç—å –º–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ –∑–∞–ø–∏—Å–∏ –∏–ª–∏ —Ö—Ä–∞–Ω–∏—Ç—å UID —Å –æ–ø—Ü–∏–µ–π —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ –ø–æ –∑–∞–ø—Ä–æ—Å—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.

**–ü—Ä–µ–¥–ª–∞–≥–∞–µ–º—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è UID/UGID.**
```sql
ALTER TABLE users ADD COLUMN uid VARCHAR(14);
ALTER TABLE users ADD CONSTRAINT uq_users_uid UNIQUE (uid);
ALTER TABLE users ADD COLUMN telegram_id BIGINT;
UPDATE users SET telegram_id = user_id WHERE telegram_id IS NULL;
-- –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è –¥–æ—á–µ—Ä–Ω–∏—Ö —Ç–∞–±–ª–∏—Ü: –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è uid/telegram_id –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏;
CREATE TABLE uid_rotation_journal (
    uid VARCHAR(14) PRIMARY KEY,
    tid BIGINT NOT NULL,
    version SMALLINT NOT NULL DEFAULT 1,
    rotated_at TIMESTAMPTZ DEFAULT NOW()
);
```
–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ `user_id` –≤ `tid` –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ (—Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ FK); –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –æ–±–µ —Ñ–æ—Ä–º—ã –∏ –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –Ω–∞ UID –∫–∞–∫ –ø—É–±–ª–∏—á–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä.

**–†–µ—Ñ–µ—Ä–∞–ª–∫–∞ v2.** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `RefInvites`/`RefClTokens` –∫–∞–∫ –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤; –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è DAL-—Å–ª–æ–π –∏ –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è –∏–Ω–¥–µ–∫—Å–æ–≤ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º. –°—Ç–∞—Ä—ã–µ –ø–æ–ª—è (`users.referred_by_id`) –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏, –Ω–æ –Ω–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –ª—É—á—à–µ —Å—Ç—Ä–æ–∏—Ç—å –≤–æ–∫—Ä—É–≥ UID + —Ç–æ–∫–µ–Ω–æ–≤.

**–ú–∏–≥—Ä–∞—Ü–∏–∏.** –¢–µ–∫—É—â–∏–π –º–∏–≥—Ä–∞—Ç–æ—Ä (`db/migrator.py:23`) –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–æ–ª–±—Ü–æ–≤ –≤ `users`. –î–ª—è —Å–µ—Ä—å—ë–∑–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π (UID, –Ω–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã) —Å–ª–µ–¥—É–µ—Ç:
- –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –≤ `MIGRATIONS` –∏ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `Base.metadata.create_all` –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏;
- –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∑–∞–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å Alembic (—É–∂–µ –≤ requirements) –¥–ª—è idempotent DDL.

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è, —Ñ–∏—á–µ—Ñ–ª–∞–≥–∏ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (PII/–ª–æ–≥–∏)
- `Settings` —Å–æ–¥–µ—Ä–∂–∏—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–æ —Ñ–ª–∞–≥–æ–≤ (TRIAL_ENABLED, REQ*CHANNEL*, SUBSCRIPTION_*), –Ω–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ `ECDC_SECRET`, `ECDC_TWEAK`, `ECDC_ITER`, `ECDC_KDF`, –Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –∏—Ö —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤ `.env.example`. –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∏—Ö –≤ `Settings` –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å `EcdcService` –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ.
- –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–µ –Ω–æ–≤—ã–µ —Ñ–∏—á–µ—Ñ–ª–∞–≥–∏: `AUTH_GUARD_ENABLED` (–≤–∫–ª—é—á–µ–Ω–∏–µ —Å–ª–æ—è post-/start –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏), `AUTH_GUARD_MODE` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `referral_code`/`invite_only`), `REFERRAL_V2_ENABLED`, `UID_ENCRYPTION_ENABLED`/`UID_ROTATION_VERSION`, `LOG_MASK_UIDS` (—Ä–µ–∂–∏–º –º–∞—Å–∫–∏—Ä–æ–≤–∫–∏ PII –≤ –ª–æ–≥–∞—Ö), `ADMIN_UID_WHITELIST` (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å —Å —à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ ID –≤ –∞–¥–º–∏–Ω–∫–µ), `PANEL_UID_MODE` (—Å—Ç—Ä–∞—Ç–µ–≥–∏—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ Remnawave).
- –ö–æ–Ω—Ñ–∏–≥–∏ –¥–æ–ª–∂–Ω—ã —á–∏—Ç–∞—Ç—å—Å—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ: –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ `config/settings.py` –∏, –¥–ª—è aiogram, –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ `Dispatcher["feature_flags"]` –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –∏–Ω—ä–µ–∫—Ü–∏–∏ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏, –∞ —Ç–∞–∫–∂–µ –≤ —Å–µ—Ä–≤–∏—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∏–Ω–∏–º–∞—é—Ç —Ä–µ—à–µ–Ω–∏—è –≤–Ω–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ Telegram.
- –ü–æ–ª–∏—Ç–∏–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è: `ActionLoggerMiddleware` –∏ `NotificationService` –¥–æ–ª–∂–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å UID/—É–≥–∏–¥ –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–º —Ñ–ª–∞–≥–µ `LOG_MASK_UIDS`; –ø—Ä–∏ –≤—ã–≤–æ–¥–µ –≤ –ª–æ–≥–∏/–∞–¥–º–∏–Ω-—á–∞—Ç—ã –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ 4 —Ü–∏—Ñ—Ä—ã –∏–ª–∏ –ø—Å–µ–≤–¥–æ–Ω–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –î–ª—è –∞—É–¥–∏—Ç–∞ –º–æ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –≤ `uid_rotation_journal`.
- –î–ª—è –≥—Ä—É–ø–ø–æ–≤—ã—Ö –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤ (LOG_CHAT_ID, –∫–∞–Ω–∞–ª—ã) —Å—Ç–æ–∏—Ç —Ö—Ä–∞–Ω–∏—Ç—å ugid (—Ñ–æ—Ä–º–∞—Ç `-XXXX-XXXX-XXXX-XXXX`) –∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º Telegram API. –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è `LOG_CHAT_ID` –≤ `.env.example` —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–∏–º–µ—Ä ugid, –Ω–æ `Settings` –ø—Ä–∏–Ω–∏–º–∞–µ—Ç `int` ‚Äî –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–º–µ–Ω–∏—Ç—å —Ç–∏–ø –Ω–∞ `str` –∏ –≤—ã–ø–æ–ª–Ω—è—Ç—å `decg` –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.

## ‚ö†Ô∏è –ú–∏–≥—Ä–∞—Ü–∏—è –∏ –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏: 1) –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –ø–æ–ª—è (uid/telegram_id/ugid) –∏ –∂—É—Ä–Ω–∞–ª —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —á–µ—Ä–µ–∑ –º–∏–≥—Ä–∞—Ç–æ—Ä; 2) –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å `EcdcService` –∏ –≤–Ω–µ–¥—Ä–∏—Ç—å –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –≤ —Ç–æ—á–∫–∞—Ö –∑–∞–ø–∏—Å–∏ (—Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, –±–∏–ª–ª–∏–Ω–≥) —Å –¥–≤–æ–π–Ω–æ–π –∑–∞–ø–∏—Å—å—é `tid` + `uid`; 3) –Ω–∞ —á—Ç–µ–Ω–∏–µ/–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–≤–æ–¥–∏—Ç—å UID, –∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è—Ö –∫ Telegram/Remnawave –≤—ã–ø–æ–ª–Ω—è—Ç—å –æ–±—Ä–∞—Ç–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ; 4) –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ñ–æ–Ω–æ–≤—ã–µ —Å–∫—Ä–∏–ø—Ç—ã –±—ç–∫—Ñ–∏–ª–ª–∞ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —Å—Å—ã–ª–æ–∫ (—Å–∫—Ä–∏–ø—Ç –Ω–∞ –±–∞–∑–µ `bot/utils/ecdc_api.py` —Å –±–∞—Ç—á–∞–º–∏, —Ä–µ—Ç—Ä–∞—è–º–∏ –∏ –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã—Ö —Å—É–º–º); 5) –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Å—Ç–∞–≤–ª—è—Ç—å `user_id` –≤ payload –≤–Ω–µ—à–Ω–∏—Ö API –∏ –ø–ª–∞—Ç–µ–∂–µ–π, –¥–æ–±–∞–≤–∏–≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É UID (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏); 6) –ø–æ—Å–ª–µ —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ –≤–∫–ª—é—á–∏—Ç—å —Ñ–∏—á–µ—Ñ–ª–∞–≥ `UID_ENCRYPTION_ENABLED` –≤ production, –∑–∞—Ç–µ–º –ø–æ—á–∏—Å—Ç–∏—Ç—å –ø—Ä—è–º—ã–µ –ø–æ—è–≤–ª–µ–Ω–∏—è tid –∏–∑ –ª–æ–≥–æ–≤/—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π. –†–∏—Å–∫–∏: –Ω–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å —Å–≤—è–∑–µ–π (FK) –ø—Ä–∏ —á–∞—Å—Ç–∏—á–Ω–æ–º –±—ç–∫—Ñ–∏–ª–ª–µ, –∑–∞–¥–µ—Ä–∂–∫–∏ –≤ –ø–∞–Ω–µ–ª—å–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (Remnawave –ø–æ–∫–∞ –æ–∂–∏–¥–∞–µ—Ç tid), –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö –≤–µ–±—Ö—É–∫–æ–≤ (metadata –¥–æ–ª–∂–Ω—ã –æ—Å—Ç–∞—Ç—å—Å—è –ø–æ–Ω—è—Ç–Ω—ã–º–∏ –±—ç–∫—É, –∏–Ω–∞—á–µ –Ω–µ —É–¥–∞—Å—Ç—Å—è –Ω–∞–π—Ç–∏ –ø–ª–∞—Ç–µ–∂). –ü–ª–∞–Ω –æ—Ç–∫–∞—Ç–∞ ‚Äî –≤–µ—Ä–Ω—É—Ç—å —Ñ–ª–∞–≥, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∂—É—Ä–Ω–∞–ª —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è tid.

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏
- –Æ–Ω–∏—Ç-—Ç–µ—Å—Ç—ã: `ecdc_api` (roundtrip 12/16-–∑–Ω–∞—á–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π, –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –≤—Ö–æ–¥—ã), –æ–±—ë—Ä—Ç–∫–∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –≤ middleware/handlers, —Ñ—É–Ω–∫—Ü–∏–∏ DAL, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω—ã UID (–Ω–∞–ø—Ä–∏–º–µ—Ä, `user_dal.create_user`, `subscription_dal.get_active_subscription_by_user_id`).
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã: —Å—Ü–µ–Ω–∞—Ä–∏–π `/start` —Å deep-link (referral/promo/ad), –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–º —Ñ–ª–∞–≥–µ), —É—Å–ø–µ—à–Ω–æ–µ/–Ω–µ—É—Å–ø–µ—à–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞, –ø–ª–∞—Ç–µ–∂ —á–µ—Ä–µ–∑ YooKassa/CryptoPay —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∞–≤—Ç–æ–ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –±–æ–Ω—É—Å–æ–≤ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –º–∞–ø–ø–∏–Ω–≥–∞ UID‚ÜîTID.
- –ö–æ–Ω—Ç—É—Ä –¥–ª—è —Ä–µ—Ñ–µ—Ä–∞–ª–∫–∏ v2: —Ç–µ—Å—Ç—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏/–ø–æ–≥–∞—à–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤ `RefInvites`, –ø–µ—Ä–µ–Ω–æ—Å –±–æ–Ω—É—Å–æ–≤ –≤ `RefList`, –∞–Ω—Ç–∏-–¥—É–±–ª—å (–æ–¥–∏–Ω —Ç–æ–∫–µ–Ω = –æ–¥–∏–Ω —Ä–µ—Ñ–µ—Ä–∞–ª), TTL.
- –ù–∞–≥—Ä—É–∑–æ—á–Ω—ã–µ/–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å: –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –≤–µ–±—Ö—É–∫–∏ (YooKassa WAITING_FOR_CAPTURE ‚Üí SUCCEEDED), –ø–æ–≤—Ç–æ—Ä–Ω—ã–π `/start` —Å —Ç–µ–º –∂–µ UID, –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞.
- Acceptance checklist (QA/—Ä—É—á–Ω–æ–π): `/start` + guard –ø–µ—Ä–µ–≤–æ–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –º–µ–Ω—é —Å –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–º UID; –Ω–æ–≤—ã–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω –Ω–∞—á–∏—Å–ª—è–µ—Ç –±–æ–Ω—É—Å—ã –±–µ–∑ —É—Ç–µ—á–µ–∫ tid; –ø–ª–∞—Ç–µ–∂ YooKassa/Stars/Tribute –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É –∏ –ø–∞–Ω–µ–ª—å –≤–∏–¥–∏—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ; –∞–¥–º–∏–Ω—Å–∫–∏–µ `/sync` –∏ `/syncstatus` —Ä–∞–±–æ—Ç–∞—é—Ç —Å UID –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–Ω–æ–º `REFERRAL_V1_ENABLED`; –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ `AUTH_GUARD_ENABLED` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–µ–∂–Ω–∏–π UX.

## üìã –í—ã–≤–æ–¥—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
- –ü—Ä–µ–∂–¥–µ —á–µ–º –≤–Ω–µ–¥—Ä—è—Ç—å UID, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ–±—Ä–∞–º–∏—Ç—å —Ä–∞–±–æ—Ç—É —Å –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞–º–∏ —Å–µ—Ä–≤–∏—Å–æ–º (`EcdcService`) –∏ –¥–æ–±–∞–≤–∏—Ç—å –¥–≤–æ–π–Ω—É—é –∑–∞–ø–∏—Å—å –≤–æ –≤—Å–µ—Ö —Å–ª–æ—è—Ö. –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç —Å–µ–π—á–∞—Å —Ç–µ—Å–Ω–æ —Å–≤—è–∑–∞–Ω—ã: —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –≤—ã–¥–µ–ª–∏—Ç—å –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏ –¥–æ—Å—Ç—É–ø–∞ –∫ Telegram API, —á—Ç–æ–±—ã —Å–µ—Ä–≤–∏—Å—ã —Å—Ç–∞–ª–∏ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–º–∏.
- –î–ª—è —Ä–µ—Ñ–µ—Ä–∞–ª–∫–∏ v2 —É–∂–µ –µ—Å—Ç—å —Å—Ö–µ–º—ã (RefCl*), –Ω–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç DAL/handlers. –°—Ç–æ–∏—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Å–ª–æ–π —Å–µ—Ä–≤–∏—Å–æ–≤ (—Å–æ–∑–¥–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤, –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç—å, —Å—Ç–∞—Ç—É—Å—ã) –∏ –º–∏–≥—Ä–∞—Ü–∏–∏. –¢–µ–∫—É—â–∞—è —Ä–µ—Ñ–µ—Ä–∞–ª–∫–∞ (–ø–æ–ª—è `referred_by_id` + –±–æ–Ω—É—Å—ã) –¥–æ–ª–∂–Ω–∞ –æ—Å—Ç–∞—Ç—å—Å—è –∑–∞ —Ñ–∏—á–µ—Ñ–ª–∞–≥–æ–º –¥–æ –ø–æ–ª–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞.
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ `/start` –ª–æ–≥–∏—á–Ω–æ –æ–ø–µ—Ä–µ—Ç—å—Å—è –Ω–∞ —Ç–µ –∂–µ —Ç–æ–∫–µ–Ω—ã/–∏–Ω–≤–∞–π—Ç—ã, —á—Ç–æ–±—ã –Ω–µ –ø–ª–æ–¥–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω—É—é —Å–∏—Å—Ç–µ–º—É. Guard –º–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫–∞–∫ FSM + middleware, –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è —Ñ–ª–∞–≥–æ–º –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.
- –í –ª–æ–≥–∞—Ö/—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è—Ö –Ω–∞–¥–æ –º–∞—Å–∫–∏—Ä–æ–≤–∞—Ç—å PII: UID/UGID + —á–µ–ª–æ–≤–µ–∫–æ-—á–∏—Ç–∞–µ–º—ã–µ –ø—Å–µ–≤–¥–æ–Ω–∏–º—ã (username/first_name) –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏.
- –£ –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ—Ç –∞–≤—Ç–æ-—Ç–µ—Å—Ç–æ–≤; –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ö–æ—Ç—è –±—ã –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –Ω–∞–±–æ—Ä–∞ (unit + –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏) –∫—Ä–∏—Ç–∏—á–Ω–æ –ø–µ—Ä–µ–¥ –º–∞—Å—à—Ç–∞–±–Ω—ã–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ (UID/—Ä–µ—Ñ–µ—Ä–∞–ª–∫–∞/auth-guard).

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
–£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏: senior friendly. –ö–æ–¥–æ–≤–∞—è –±–∞–∑–∞ –∫—Ä—É–ø–Ω–∞—è, —Å–æ–¥–µ—Ä–∂–∏—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π –∏ —Ç–µ—Ö–Ω–∏–∫ (async SQLAlchemy, –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–ª–∞—Ç—ë–∂–Ω—ã—Ö —à–ª—é–∑–æ–≤, —Ñ–æ—Ä–º–∞—Ç-—Å–æ—Ö—Ä–∞–Ω—è—é—â–µ–µ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ), –∞ —Ç—Ä–µ–±—É–µ–º—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞—Ç—Ä–∞–≥–∏–≤–∞—é—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É, –ë–î –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å ‚Äî –æ–∂–∏–¥–∞–µ—Ç—Å—è –æ–ø—ã—Ç–Ω—ã–π —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫/—Ç–∏–º–ª–∏–¥.
